#!/bin/bash

# =======================================================================================
# Run as root
# =======================================================================================
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Check for valid smOSMiner and newMinerURL
# =======================================================================================
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Set Variables
# =======================================================================================
# Location of smOS miners
smOSMiner=$1
newMinerURL=$2
newMiner=basename -s .tar.gz ${newMinerURL}
smOSMinerRoot="/root/miner_org/"
smOSDownloadURL="http://download.simplemining.net/miners/"
smOSMiners=($(awk -F'"' 'NR!=1 && !/md5/ {print $2}'<<< $(curl -sSL ${smOSDownloadURL})))
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Discover smOS miner binary name
# =======================================================================================
smOSMinerDIR=${smOSMinerRoot}${smOSMiner}
if [ ! -d "${smOSMinerDIR}" ];
	then curl -fsL ${smOSDownloadURL}${smOSMiner} | tar xvz -C ${smOSMinerRoot};
fi
smOSMinerBin="$(find ${smOSMinerDIR}/ -maxdepth 1 -type f -size +512k -executable -printf "%f\n" -quit)"
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Delete selected miner directory
# =======================================================================================
rm -rf ${smOSMinerDIR}
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Download new miner into smOS miner location
# =======================================================================================
curl -fsL ${newMinerURL} | tar xvz -C ${smOSMinerDIR} --strip-components 1
newMinerBin="$(find ${smOSMinerDIR}/ -maxdepth 1 -type f -size +512k -executable -printf "%f\n" -quit)"
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Switch out miner and create masquerade symlink
# =======================================================================================
ln -s ${smOSMinerDIR}/${newMiner} ${smOSMinerDIR}/${smOSMinerBin}
chmod +x ${smOSMinerDIR}/${newMinerBin}
chown -R miner:miner ${smOSMinerDIR}
# ---------------------------------------------------------------------------------------

# =======================================================================================
# Done.
# =======================================================================================
echo "###"
echo "$smOSMiner is now $newMiner!"
echo "###"
echo ""
echo ""
echo "###"
echo "Configure your Rig Group for $smOSMiner at simplemining.net remembering that it is now $newMiner and use the appropriate config for the new miner."
echo "###"
# ---------------------------------------------------------------------------------------
